<?xml version="1.0" encoding="UTF-8"?>
<!--
  Copyright (c) 2020-2021, NVIDIA CORPORATION.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>

  <parent>
    <groupId>com.nvidia</groupId>
    <artifactId>rapids-4-spark-parent</artifactId>
    <version>21.10.0-SNAPSHOT</version>
  </parent>
  <artifactId>rapids-4-spark-aggregator_2.12</artifactId>
  <name>RAPIDS Accelerator for Apache Spark Aggregator</name>
  <description>Creates an aggregated shaded package of the RAPIDS plugin for Apache Spark</description>
  <version>21.10.0-SNAPSHOT</version>

  <properties>
      <rapids.shade.package>com.nvidia.shaded.${spark.version.classifier}.spark</rapids.shade.package>
  </properties>
  <profiles>
    <profile>
        <id>with-classifier</id>
        <activation>
            <activeByDefault>true</activeByDefault>
        </activation>
        <dependencies>
            <dependency>
               <groupId>com.nvidia</groupId>
               <artifactId>rapids-4-spark-sql_${scala.binary.version}</artifactId>
               <version>${project.version}</version>
               <classifier>${spark.version.classifier}</classifier>
            </dependency>
            <dependency>
               <groupId>com.nvidia</groupId>
               <artifactId>rapids-4-spark-shuffle_${scala.binary.version}</artifactId>
               <version>${project.version}</version>
               <classifier>${spark.version.classifier}</classifier>
            </dependency>
            <dependency>
               <groupId>com.nvidia</groupId>
               <artifactId>rapids-4-spark-udf_${scala.binary.version}</artifactId>
               <version>${project.version}</version>
               <classifier>${spark.version.classifier}</classifier>
            </dependency>
            <dependency>
               <groupId>com.nvidia</groupId>
               <artifactId>rapids-4-spark-shims-${spark.version.classifier}_${scala.binary.version}</artifactId>
               <version>${project.version}</version>
            </dependency>
            <dependency>
               <!-- required for conf generation script -->
               <groupId>org.apache.spark</groupId>
               <artifactId>spark-sql_${scala.binary.version}</artifactId>
               <scope>provided</scope>
            </dependency>
            <dependency>
              <!-- required for conf generation script -->
              <groupId>org.apache.spark</groupId>
              <artifactId>spark-hive_${scala.binary.version}</artifactId>
              <scope>provided</scope>
            </dependency>
        </dependencies>
  <build>
    <plugins>
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-shade-plugin</artifactId>
        <configuration>
          <artifactSet>
            <excludes>org.slf4j:*</excludes>
          </artifactSet>
	  <transformers>
            <transformer implementation="org.apache.maven.plugins.shade.resource.ServicesResourceTransformer"/>
	  </transformers>
          <createDependencyReducedPom>true</createDependencyReducedPom>
          <shadedArtifactAttached>true</shadedArtifactAttached>
          <shadedClassifierName>${spark.version.classifier}</shadedClassifierName>
          <relocations>
            <relocation>
              <pattern>org.apache.orc.</pattern>
              <shadedPattern>${rapids.shade.package}.orc.</shadedPattern>
            </relocation>
            <relocation>
              <pattern>org.apache.hadoop.hive.</pattern>
              <shadedPattern>${rapids.shade.package}.hadoop.hive.</shadedPattern>
              <excludes>
                <exclude>org.apache.hadoop.hive.conf.HiveConf</exclude>
                <exclude>org.apache.hadoop.hive.ql.exec.UDF</exclude>
                <exclude>org.apache.hadoop.hive.ql.udf.generic.GenericUDF</exclude>
              </excludes>
            </relocation>
            <relocation>
              <pattern>org.apache.hive.</pattern>
              <shadedPattern>${rapids.shade.package}.hive.</shadedPattern>
            </relocation>
            <relocation>
              <pattern>io.airlift.compress.</pattern>
              <shadedPattern>${rapids.shade.package}.io.airlift.compress.</shadedPattern>
            </relocation>
            <relocation>
              <pattern>org.apache.commons.codec.</pattern>
              <shadedPattern>${rapids.shade.package}.org.apache.commons.codec.</shadedPattern>
            </relocation>
            <relocation>
              <pattern>org.apache.commons.lang.</pattern>
              <shadedPattern>${rapids.shade.package}.org.apache.commons.lang.</shadedPattern>
            </relocation>

            <relocation>
              <pattern>com.google</pattern>
              <shadedPattern>${rapids.shade.package}.com.google</shadedPattern>
            </relocation>
          </relocations>
        </configuration>
        <executions>
          <execution>
            <phase>package</phase>
            <goals>
              <goal>shade</goal>
            </goals>
            <configuration>
              <filters>
                <filter>
                  <artifact>com.nvidia:rapids-4-spark-aggregator_2.12</artifact>
                  <includes>
                    <include>META-INF/**</include>
                  </includes>
                  <excludes>
                    <exclude>META-INF/**</exclude>
                    <exclude>META-INF/services/**</exclude>
                  </excludes>
                </filter>
              </filters>
            </configuration>
          </execution>
        </executions>
      </plugin>
  </plugins>
  </build>
    </profile>
    <profile>
        <id>release311cdh</id>
        <activation>
            <property>
                <name>buildver</name>
                <value>311cdh</value>
            </property>
        </activation>
        <dependencies>
            <dependency>
                <groupId>org.apache.spark</groupId>
                <artifactId>spark-sql_${scala.binary.version}</artifactId>
                <version>${spark311cdh.version}</version>
                <exclusions>
                    <exclusion>
                        <groupId>org.apache.curator</groupId>
                        <artifactId>curator-recipes</artifactId>
                    </exclusion>
                </exclusions>
                <scope>provided</scope>
            </dependency>
            <dependency>
                <groupId>org.apache.curator</groupId>
                <artifactId>curator-recipes</artifactId>
                <version>4.3.0.7.2.7.0-184</version>
                <scope>provided</scope>
            </dependency>
           <dependency>
                <!-- it seems CDH jars pull an old version of Guava but need new version
                     to run with, so here we override Guava version for testing -->
                <groupId>com.google.guava</groupId>
                <artifactId>guava</artifactId>
                <version>${guava.cdh.version}</version>
                <scope>provided</scope>
            </dependency>
            <dependency>
               <groupId>com.nvidia</groupId>
               <artifactId>rapids-4-spark-sql_${scala.binary.version}</artifactId>
               <version>${project.version}</version>
               <classifier>${spark.version.classifier}</classifier>
            </dependency>
            <dependency>
               <groupId>com.nvidia</groupId>
               <artifactId>rapids-4-spark-shuffle_${scala.binary.version}</artifactId>
               <version>${project.version}</version>
               <classifier>${spark.version.classifier}</classifier>
            </dependency>
            <dependency>
               <groupId>com.nvidia</groupId>
               <artifactId>rapids-4-spark-udf_${scala.binary.version}</artifactId>
               <version>${project.version}</version>
               <classifier>${spark.version.classifier}</classifier>
            </dependency>
            <dependency>
               <groupId>com.nvidia</groupId>
               <artifactId>rapids-4-spark-shims-${spark.version.classifier}_${scala.binary.version}</artifactId>
               <version>${project.version}</version>
            </dependency>
            <dependency>
              <!-- required for conf generation script -->
              <groupId>org.apache.spark</groupId>
              <artifactId>spark-hive_${scala.binary.version}</artifactId>
              <scope>provided</scope>
            </dependency>
        </dependencies>
  <build>
    <plugins>
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-shade-plugin</artifactId>
        <configuration>
          <artifactSet>
            <excludes>org.slf4j:*</excludes>
          </artifactSet>
	  <transformers>
            <transformer implementation="org.apache.maven.plugins.shade.resource.ServicesResourceTransformer"/>
	  </transformers>
          <createDependencyReducedPom>true</createDependencyReducedPom>
          <shadedArtifactAttached>true</shadedArtifactAttached>
          <shadedClassifierName>${spark.version.classifier}</shadedClassifierName>
          <relocations>
            <relocation>
              <pattern>org.apache.orc.</pattern>
              <shadedPattern>${rapids.shade.package}.orc.</shadedPattern>
            </relocation>
            <relocation>
              <pattern>org.apache.hadoop.hive.</pattern>
              <shadedPattern>${rapids.shade.package}.hadoop.hive.</shadedPattern>
              <excludes>
                <exclude>org.apache.hadoop.hive.conf.HiveConf</exclude>
                <exclude>org.apache.hadoop.hive.ql.exec.UDF</exclude>
                <exclude>org.apache.hadoop.hive.ql.udf.generic.GenericUDF</exclude>
              </excludes>
            </relocation>
            <relocation>
              <pattern>org.apache.hive.</pattern>
              <shadedPattern>${rapids.shade.package}.hive.</shadedPattern>
            </relocation>
            <relocation>
              <pattern>io.airlift.compress.</pattern>
              <shadedPattern>${rapids.shade.package}.io.airlift.compress.</shadedPattern>
            </relocation>
            <relocation>
              <pattern>org.apache.commons.codec.</pattern>
              <shadedPattern>${rapids.shade.package}.org.apache.commons.codec.</shadedPattern>
            </relocation>
            <relocation>
              <pattern>org.apache.commons.lang.</pattern>
              <shadedPattern>${rapids.shade.package}.org.apache.commons.lang.</shadedPattern>
            </relocation>

            <relocation>
              <pattern>com.google</pattern>
              <shadedPattern>${rapids.shade.package}.com.google</shadedPattern>
            </relocation>
          </relocations>
        </configuration>
        <executions>
          <execution>
            <phase>package</phase>
            <goals>
              <goal>shade</goal>
            </goals>
            <configuration>
              <filters>
                <filter>
                  <artifact>com.nvidia:rapids-4-spark-aggregator_2.12</artifact>
                  <includes>
                    <include>META-INF/**</include>
                  </includes>
                  <excludes>
                    <exclude>META-INF/**</exclude>
                    <exclude>META-INF/services/**</exclude>
                  </excludes>
                </filter>
              </filters>
            </configuration>
          </execution>
        </executions>
    </plugin>
  </plugins>
  </build>
    </profile>
  </profiles>


  <build>
    <plugins>
      <plugin>
        <groupId>net.alchim31.maven</groupId>
        <artifactId>scala-maven-plugin</artifactId>
        <executions>
          <execution>
            <id>update_config</id>
            <phase>verify</phase>
            <goals>
              <goal>run</goal>
            </goals>
            <configuration>
              <launchers>
                <launcher>
                  <id>update_rapids_config</id>
                  <mainClass>com.nvidia.spark.rapids.RapidsConf</mainClass>
                  <args>
                    <arg>${project.basedir}/../docs/configs.md</arg>
                  </args>
                </launcher>
              </launchers>
            </configuration>
          </execution>
          <execution>
            <id>update_supported</id>
            <phase>verify</phase>
            <goals>
              <goal>run</goal>
            </goals>
            <configuration>
              <launchers>
                <launcher>
                  <id>update_rapids_support</id>
                  <mainClass>com.nvidia.spark.rapids.SupportedOpsDocs</mainClass>
                  <args>
                    <arg>${project.basedir}/../docs/supported_ops.md</arg>
                  </args>
                </launcher>
              </launchers>
            </configuration>
          </execution>
          <execution>
            <id>update_supported_tools</id>
            <phase>verify</phase>
            <goals>
              <goal>run</goal>
            </goals>
            <configuration>
              <launchers>
                <launcher>
                  <id>update_rapids_support_tools</id>
                  <mainClass>com.nvidia.spark.rapids.SupportedOpsForTools</mainClass>
                  <args>
                      <arg>${project.basedir}/../tools/src/main/resources/supportedDataSource.csv</arg>
                  </args>
                </launcher>
              </launchers>
            </configuration>
          </execution>
        </executions>
      </plugin>
      <plugin>
        <groupId>org.apache.rat</groupId>
        <artifactId>apache-rat-plugin</artifactId>
      </plugin>
    </plugins>
  </build>

</project>
